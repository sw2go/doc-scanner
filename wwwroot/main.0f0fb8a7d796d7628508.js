(()=>{const t=Blob.prototype.arrayBuffer||function(){return new Promise(((t,e)=>{const o=new FileReader;o.onload=()=>{t(o.result)},o.onerror=()=>{e(o.error)},o.readAsArrayBuffer(this)}))},e=document.createElement("canvas"),o=e.getContext("2d"),n=(t,e,o)=>t<e?e:t>o?o:t,a=(t,e=new Float32Array(t.buffer,t.byteOffset,t.byteLength>>2))=>{for(let o=0;o<e.length;++o){const n=o<<2;e[o]=.00116796875*t[n]+.00229296875*t[n+1]+.0004453125*t[n+2]}return e},r=new Float32Array([.01258,.02516,.03145,.02516,.01258,.02516,.0566,.07547,.0566,.02516,.03145,.07547,.09434,.07547,.03145,.02516,.0566,.07547,.0566,.02516,.01258,.02516,.03145,.02516,.01258]),l=new Float32Array(256),c=new Float32Array(256);for(let t=0;t<256;++t){const e=Math.PI*t/256;l[t]=Math.cos(e),c[t]=Math.sin(e)}c[0]=l[128];const s=(t,e=new Float32Array(9))=>(e[0]=t[4]*t[8]-t[5]*t[7],e[1]=t[2]*t[7]-t[1]*t[8],e[2]=t[1]*t[5]-t[2]*t[4],e[3]=t[5]*t[6]-t[3]*t[8],e[4]=t[0]*t[8]-t[2]*t[6],e[5]=t[2]*t[3]-t[0]*t[5],e[6]=t[3]*t[7]-t[4]*t[6],e[7]=t[1]*t[6]-t[0]*t[7],e[8]=t[0]*t[4]-t[1]*t[3],e),h=(t,e,o=new Float32Array(9))=>(o[0]=t[0]*e[0]+t[1]*e[3]+t[2]*e[6],o[1]=t[0]*e[1]+t[1]*e[4]+t[2]*e[7],o[2]=t[0]*e[2]+t[1]*e[5]+t[2]*e[8],o[3]=t[3]*e[0]+t[4]*e[3]+t[5]*e[6],o[4]=t[3]*e[1]+t[4]*e[4]+t[5]*e[7],o[5]=t[3]*e[2]+t[4]*e[5]+t[5]*e[8],o[6]=t[6]*e[0]+t[7]*e[3]+t[8]*e[6],o[7]=t[6]*e[1]+t[7]*e[4]+t[8]*e[7],o[8]=t[6]*e[2]+t[7]*e[5]+t[8]*e[8],o),y=(t,e,o=new Float32Array(3))=>(o[0]=t[0]*e[0]+t[1]*e[1]+t[2]*e[2],o[1]=t[3]*e[0]+t[4]*e[1]+t[5]*e[2],o[2]=t[6]*e[0]+t[7]*e[1]+t[8]*e[2],o),f=({a:t,b:e,c:o,d:n})=>{const a=new Float32Array([t.x,e.x,o.x,t.y,e.y,o.y,1,1,1]),r=y(s(a),new Float32Array([n.x,n.y,1]));return h(a,new Float32Array([r[0],0,0,0,r[1],0,0,0,r[2]]))},i=({a:t,b:e,c:o,d:n})=>Math.hypot(t.x-e.x,t.y-e.y)+Math.hypot(o.x-n.x,o.y-n.y)>Math.hypot(e.x-o.x,e.y-o.y)+Math.hypot(n.x-t.x,n.y-t.y)?t.x+e.x<o.x+n.x?t.y>e.y?{a:t,b:e,c:o,d:n}:{a:e,b:t,c:n,d:o}:o.y>n.y?{a:o,b:n,c:t,d:e}:{a:n,b:o,c:e,d:t}:e.x+o.x<n.x+t.x?e.y>o.y?{a:e,b:o,c:n,d:t}:{a:o,b:e,c:t,d:n}:n.y>t.y?{a:n,b:t,c:e,d:o}:{a:t,b:n,c:o,d:e},d=async e=>{const o=[];let n=0;const a=[],r=t=>{o.push(t),n+=t.length},l=t=>{r(" "),r(t)},c=t=>{let e=0;for(const o of t)e+=o.length;const o=new Uint8Array(e);e=0;for(const n of t){if("string"==typeof n)for(let t=0;t<n.length;++t)o[t+e]=n.charCodeAt(t);else o.set(n,e);e+=n.length}return o},s=t=>{r("%"+t+"\n")},h=t=>{l(t.toString())},y=t=>{l("/"+t)},f=t=>{l("["),t(),l("]")},i=t=>{l("<<");for(const e in t)y(e),t[e]();l(">>")},d=(t,e)=>{i(t),l("stream\n"),r(e),r("endstream")},g=t=>(r(" "),r(a.push(n)+" 0 obj"),t(),l("endobj"),a.length),u=t=>{l(t+" 0 R")};s("PDF-1.4"),s("úã");const x=await Promise.all(e.map((async e=>{const o=document.createElement("canvas");o.width=e.width,o.height=e.height,o.getContext("2d").putImageData(e,0,0);const n=await new Promise((t=>o.toBlob(t,"image/jpeg"))),r=new Uint8Array(await t.call(n)),l=g((()=>{d({Type(){y("XObject")},Subtype(){y("Image")},Width(){h(e.width)},Height(){h(e.height)},ColorSpace(){y("DeviceRGB")},BitsPerComponent(){h(8)},Filter(){y("DCTDecode")},Length(){h(r.length)}},r)})),s=792*e.width/e.height,x=g((()=>{const t=`${s} 0 0 792 0 0 cm /I Do`;d({Length(){h(t.length)}},c([t]))}));return g((()=>{i({Type(){y("Page")},Parent(){u(a.length+1)},Resources(){i({XObject(){i({I(){u(l)}})}})},Contents(){u(x)},MediaBox(){f((()=>{h(0),h(0),h(s),h(792)}))}})}))}))),b=g((()=>{i({Type(){y("Pages")},Kids(){f((()=>{for(const t of x)u(t)}))},Count(){h(x.length)}})})),m=g((()=>{i({Type(){y("Catalog")},Pages(){u(b)}})}));r("\n");const M=n;r("xref\n0 "+(a.length+1)+"\n0000000000 65535 f \n");for(const t of a)r(t.toString().padStart(10,"0")+" 00000 n \n");return r("trailer"),i({Size(){h(a.length+1)},Root(){u(m)}}),r("\nstartxref\n"+M+"\n%%EOF"),c(o)},g=({data:t,width:e,height:o},s=3)=>{console.time("document");const h=Math.hypot(e,o),y=Math.floor(h);let f=e/360;f<2?f=1:f>5&&(f=5);const d=Math.floor(e/f),g=Math.floor(o/f),u=d*g,x=new Float32Array(3*u+(y<<8)),b=x.subarray(0,u),m=x.subarray(u,u<<1),M=x.subarray(u<<1,3*u),w=x.subarray(3*u);1==f?a(t,M):((t,e,o,n,a)=>{const r=Math.floor(e/n),l=Math.floor(o/n);a||(a=new Float32Array(l*r));const c=n*n,s=l-1,h=r-1;for(let o=1;o<s;++o){const l=o*n,s=l+n,y=Math.floor(l),f=y+1,i=Math.floor(s),d=f-l,g=s-i;for(let l=1;l<h;++l){const s=l*n,h=s+n,u=Math.floor(s),x=u+1,b=Math.floor(h),m=x-s,M=h-b;let w=0;for(let o=f;o<i;++o)for(let n=x;n<b;++n)w+=t[o*e+n];for(let o=x;o<b;++o)w+=t[y*e+o]*d,w+=t[i*e+o]*g;for(let o=f;o<i;++o)w+=t[o*e+u]*m,w+=t[o*e+b]*M;w+=t[y*e+u]*d*m,w+=t[y*e+b]*d*M,w+=t[i*e+u]*g*m,w+=t[i*e+b]*g*M,a[o*r+l]=w/c}}for(let t=1;t<s;++t)a[t*r]=a[t*r+1],a[t*r+h]=a[t*r+h-1];for(let t=0;t<r;++t)a[t]=a[t+r],a[s*r+t]=a[(s-1)*r+t]})(a(t,new Float32Array(e*o)),e,o,f,M),console.timeLog("document","grayscale"),((t,e,o,a)=>{((t,e,o,a,r,l=new Float32Array(t.length))=>{const c=1+(r<<1),s=o-c,h=e-c;for(let y=0;y<o;++y)for(let o=0;o<e;++o){let f=0;const i=n(y-r,0,s),d=n(o-r,0,h);for(let o=0;o<c;++o)for(let n=0;n<c;++n)f+=t[(o+i)*e+(n+d)]*a[o*c+n];l[y*e+o]=f}})(t,e,o,r,2,a)})(M,d,g,b),console.timeLog("document","blur");const p=d-1,A=d,L=d+1,F=g-1,R=d-1;let P=0;for(let t=1;t<F;++t)for(let e=1;e<R;++e){const o=t*d+e,n=b[o-L],a=b[o-A],r=b[o-p],s=b[o-1],y=b[o+1],f=b[o+p],i=b[o+A],g=b[o+L],u=10*(y-s)+3*(r+g-n-f),x=10*(a-i)+3*(r+n-g-f),M=x/u,F=Math.pow(u*u+x*x,.3),R=Math.floor(256*Math.atan(M)/Math.PI)+128;for(let o=-32;o<=32;++o){let n=R+o&255;w[(l[n]*t+c[n]*e+h>>1<<8)+n]+=F/(o*o+3)}m[o]=F,P+=F}const I=P/((g-2)*(d-2));console.timeLog("document","tally");let U=0;for(let t=0;t<w.length;++t)U=Math.max(w[t],U);console.timeLog("document","tally2");for(let t=.05*U,e=s;e>0;--e,t*=.5){let o=[];for(let e=0;e<y;++e)for(let n=0;n<256;++n){let a=w[(e<<8)+n];a>t&&o.push({b:e,a:n,s:a})}console.timeLog("document","tally3"),o.sort(((t,e)=>e.s-t.s));const n=Math.ceil(.025*y),a=Math.ceil(6.4);for(let t=0;t<o.length;++t){const{b:e,a:r,s:l}=o[t];let c=l;for(let l=t+1;l<o.length;++l){const{b:t,a:s,s:h}=o[l];let y=Math.abs(r-s);Math.abs(e-t)<=n&&Math.min(y,256-y)<=a&&(o.splice(l,1),c+=h,--l)}o[t].s=c}console.timeLog("document","hough");const r=(t,e)=>{const o=c[t.a],n=c[e.a],a=l[t.a],r=l[e.a],s=(t.b<<1)-h,y=(o*((e.b<<1)-h)-n*s)/(o*r-n*a);return{x:(s-y*a)/o,y}},s=t=>{const e=t.x/d-.5,o=t.y/g-.5;return e*e+o*o<=.55};o.sort(((t,e)=>e.s-t.s)),console.log(o),o.length>20&&(o=o.slice(0,20),e=1);const u=(t,e)=>{let o=0;const n=Math.round(t.x),a=Math.round(t.y),r=Math.round(e.x),l=Math.round(e.y),c=Math.abs(r-n),s=-Math.abs(l-a),h=n<r?1:-1,y=a<l?1:-1;for(let t=n,e=a,f=c+s;t!=r||e!=l;){o+=(m[e*d+t]||0)-I;const n=2*f;n>=s&&(f+=s,t+=h),n<=c&&(f+=c,e+=y)}return o*(Math.pow(c-s,-.6)||0)},x=({a:t,b:e,c:o,d:n})=>Math.pow(u(t,e)+u(e,o)+u(o,n)+u(n,t),2),b=(t,e)=>{const o=Math.abs(t.a-e.a)-128;return o*o+1},M=(t,e,o,n)=>{const a=b(t,e),r=b(e,o),l=b(o,n),c=b(n,t);return Math.pow(a*a+r*r+l*l+c*c,-.3)*Math.pow(t.s*e.s*o.s*n.s,.1)},p=[];for(let t=0;t<o.length;++t){const e=o[t];for(let n=t+1;n<o.length;++n){const t=o[n],a=r(e,t);for(let l=n+1;l<o.length;++l){const n=o[l],c=r(e,n),h=r(t,n);if(s(a)){if(s(c)){if(!s(h))for(let h=l+1;h<o.length;++h){const l=o[h],y=r(e,l),f=r(t,l),i=r(n,l);if(!s(y)&&s(f)&&s(i)){const o={a,b:c,c:i,d:f};p.push({q:o,s:x(o)*M(e,n,l,t)})}}}else if(s(h))for(let c=l+1;c<o.length;++c){const l=o[c],y=r(e,l),f=r(t,l),i=r(n,l);if(!s(f)&&s(y)&&s(i)){const o={a,b:h,c:i,d:y};p.push({q:o,s:x(o)*M(t,n,l,e)})}}}else if(s(c)&&s(h))for(let a=l+1;a<o.length;++a){const l=o[a],y=r(e,l),f=r(t,l);if(!s(r(n,l))&&s(y)&&s(f)){const o={a:c,b:h,c:f,d:y};p.push({q:o,s:x(o)*M(n,t,l,e)})}}}}}if(console.timeLog("document","rects"),p.sort(((t,e)=>e.s-t.s)),console.log(p),!p.length)continue;const A=i(p[0].q);return console.timeEnd("document"),{a:{x:A.a.x*f,y:A.a.y*f},b:{x:A.b.x*f,y:A.b.y*f},c:{x:A.c.x*f,y:A.c.y*f},d:{x:A.d.x*f,y:A.d.y*f}}}},u=document.getElementById("img-input"),x=document.getElementById("done"),b=[];u.addEventListener("change",(async()=>{const t=await(async t=>{const n=document.createElement("img"),a=new Promise(((t,e)=>{n.onload=()=>{t()},n.onerror=t=>{e(t)}}));return n.src=URL.createObjectURL(t),await a,URL.revokeObjectURL(n.src),e.width=n.width,e.height=n.height,o.drawImage(n,0,0),o.getImageData(0,0,n.width,n.height)})(u.files[0]);let n=g(t);n&&b.push((({data:t,width:e,height:o},n)=>{const a=Math.floor(Math.max(Math.hypot(n.a.x-n.b.x,n.a.y-n.b.y)+Math.hypot(n.c.x-n.d.x,n.c.y-n.d.y))/2),r=(Math.floor((Math.hypot(n.a.x-n.d.x,n.a.y-n.d.y)+Math.hypot(n.b.x-n.c.x,n.b.y-n.c.y))/2),Math.min(a,1584)),l=Math.floor(8.5/11*r),c=((t,e)=>{const o=f(t),n=f(e),a=h(n,s(o));return t=>{const e=y(a,new Float32Array([t.x,t.y,1]));return{x:e[0]/e[2],y:e[1]/e[2]}}})({a:{x:0,y:r},b:{x:0,y:0},c:{x:l,y:0},d:{x:l,y:r}},n),i=new Uint8ClampedArray(l*r*4),d=e<<2,g=d+4;for(let n=0;n<r;++n)for(let a=0;a<l;++a){const r=c({x:a,y:n}),s=Math.floor(r.x),h=Math.floor(r.y),y=4*(n*l+a);if(i[y+3]=255,s>=-1&&s<e&&h>=-1&&h<o){const o=r.x-s,n=1-o,a=r.y-h,l=1-a,c=4*(h*e+s);for(let e=0;e<3;++e){const r=c+e;let s=t[r]*n+t[r+4]*o,h=t[r+d]*n+t[r+g]*o;i[y+e]=s*l+h*a}}}return new ImageData(i,l,r)})(t,n))})),x.addEventListener("click",(async()=>{((t,e)=>{const o=URL.createObjectURL(t),n=document.createElement("a");n.download="out.pdf",n.href=o,n.click(),URL.revokeObjectURL(o)})(new Blob([await d(b)]))}))})();
//# sourceMappingURL=main.0f0fb8a7d796d7628508.js.map